{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/sanghojeong/Desktop/Projects/%EA%B6%8C%EB%A6%AC%EA%B8%88%EC%A4%91%EA%B0%9C%EC%95%B1/shop-transfer-1.0/lib/toast.ts"],"sourcesContent":["export function toast(message: string) {\n    if (typeof window === \"undefined\") return;\n    window.dispatchEvent(new CustomEvent(\"app:toast\", { detail: { message } }));\n  }\n  "],"names":[],"mappings":";;;;AAAO,SAAS,MAAM,OAAe;IACjC;;IACA,OAAO,aAAa,CAAC,IAAI,YAAY,aAAa;QAAE,QAAQ;YAAE;QAAQ;IAAE;AAC1E","debugId":null}},
    {"offset": {"line": 24, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/sanghojeong/Desktop/Projects/%EA%B6%8C%EB%A6%AC%EA%B8%88%EC%A4%91%EA%B0%9C%EC%95%B1/shop-transfer-1.0/app/chat/%5Bid%5D/ClientChat.tsx"],"sourcesContent":["// app/chat/[id]/ClientChat.tsx\n\"use client\";\n\nimport { toast } from \"@/lib/toast\";\nimport { useEffect, useMemo, useRef, useState } from \"react\";\nimport useSWR, { mutate } from \"swr\";\n\ntype Message = { id: string; from: string; text: string; at: string };\n\nconst fetcher = (url: string) =>\n  fetch(url, { cache: \"no-store\" }).then((r) => r.json());\n\n// 아주 짧은 “핑” 소리(웹오디오)\nfunction ping() {\n  try {\n    const ctx = new (window.AudioContext || (window as any).webkitAudioContext)();\n    const o = ctx.createOscillator();\n    const g = ctx.createGain();\n    o.type = \"sine\";\n    o.frequency.value = 880;\n    g.gain.setValueAtTime(0.001, ctx.currentTime);\n    g.gain.exponentialRampToValueAtTime(0.05, ctx.currentTime + 0.01);\n    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.25);\n    o.connect(g);\n    g.connect(ctx.destination);\n    o.start();\n    o.stop(ctx.currentTime + 0.26);\n  } catch {\n    /* ignore */\n  }\n}\n\nexport default function ClientChat({\n  threadId,\n  role,\n}: {\n  threadId: string;\n  role: \"admin\" | \"user\";\n}) {\n  const key = threadId ? `/api/chat/threads/${threadId}/messages` : null;\n  const { data } = useSWR<{ ok: boolean; items: Message[] }>(key, fetcher, {\n    refreshInterval: 2500,\n  });\n\n  const [text, setText] = useState(\"\");\n  const bottomRef = useRef<HTMLDivElement | null>(null);\n  const prevLen = useRef<number>(0);\n  const items: Message[] = useMemo(() => data?.items ?? [], [data]);\n\n  // 방 입장 시 읽음 처리 + 배지 즉시 갱신\n  useEffect(() => {\n    if (!threadId) return;\n    (async () => {\n      const res = await fetch(\n        `/api/chat/threads/${threadId}/read?role=${role}`,\n        { method: \"POST\" }\n      );\n      if (res.ok) {\n        mutate(\"/api/chat/unread\");\n        // mutate(\"/api/chat/threads\"); // 필요 시 관리자 목록 즉시 갱신\n      }\n    })();\n  }, [threadId, role]);\n\n  // 새 메시지 → 하단 스크롤 + 소리/토스트(상대 메시지) + 포커스 외인 경우에만\n  useEffect(() => {\n    const len = items.length;\n    if (!len) return;\n    bottomRef.current?.scrollIntoView({ behavior: \"smooth\" });\n\n    if (prevLen.current && len > prevLen.current) {\n      const newOnes = items.slice(prevLen.current);\n      const incoming = newOnes.find((m) => m.from !== role);\n      const hidden =\n        typeof document !== \"undefined\" &&\n        (document.visibilityState === \"hidden\" || !document.hasFocus());\n\n      if (incoming && hidden) {\n        ping();\n        toast(\"새 메시지가 도착했습니다\");\n        if (\"Notification\" in window && Notification.permission === \"granted\") {\n          new Notification(\"새 메시지\", { body: incoming.text });\n        }\n      }\n    }\n    prevLen.current = len;\n  }, [items, role]);\n\n  // 알림 권한(최초 1회)\n  useEffect(() => {\n    if (typeof window !== \"undefined\" && \"Notification\" in window) {\n      if (Notification.permission === \"default\") {\n        Notification.requestPermission().catch(() => {});\n      }\n    }\n  }, []);\n\n  const send = async () => {\n    const body = text.trim();\n    if (!threadId || !body) return;\n\n    // 낙관적 업데이트\n    const opt: Message = {\n      id: `opt-${Date.now()}`,\n      from: role,\n      text: body,\n      at: new Date().toISOString(),\n    };\n    prevLen.current += 1;\n    setText(\"\");\n    // 화면 즉시 반영\n    (async () => {\n      // 로컬로 먼저 반영\n      // SWR 캐시를 직접 갱신하는 방법도 있지만 여기선 간단히 mutate(key)로 동기화\n      const r = await fetch(`/api/chat/threads/${threadId}/messages`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({ from: role, text: body }),\n      });\n      const j = await r.json().catch(() => ({} as any));\n      if (j?.ok) {\n        mutate(key);                 // 목록 새로고침\n        mutate(\"/api/chat/unread\");  // 배지 갱신\n      } else {\n        toast(`전송 실패: ${j?.error ?? r.statusText ?? \"error\"}`);\n      }\n    })();\n  };\n\n  return (\n    <main className=\"max-w-3xl mx-auto h-[calc(100dvh-2rem)] p-4 flex flex-col gap-3\">\n      <header className=\"rounded-2xl border px-4 py-3 bg-white\">\n        <div className=\"font-semibold\">\n          {role === \"admin\" ? \"고객과의 대화\" : \"매도자/중개사와의 대화\"}\n        </div>\n        <div className=\"text-xs text-neutral-500\">\n          현재 역할: {role === \"admin\" ? \"관리자\" : \"사용자\"}\n        </div>\n      </header>\n\n      <section className=\"flex-1 rounded-2xl border bg-white p-3 overflow-y-auto\">\n        {items.length === 0 ? (\n          <div className=\"text-sm text-neutral-500\">대화를 시작해 보세요.</div>\n        ) : (\n          <ul className=\"space-y-2\">\n            {items.map((m) => (\n              <li\n                key={m.id}\n                className={[\n                  \"max-w-[80%] px-3 py-2 rounded-lg text-sm\",\n                  m.from === role\n                    ? \"ml-auto bg-sky-500 text-white\"\n                    : \"mr-auto bg-neutral-100\",\n                ].join(\" \")}\n                title={new Date(m.at).toLocaleString()}\n              >\n                {m.text}\n              </li>\n            ))}\n            <div ref={bottomRef} />\n          </ul>\n        )}\n      </section>\n\n      <footer className=\"flex items-center gap-2\">\n        <input\n          value={text}\n          onChange={(e) => setText(e.target.value)}\n          onKeyDown={(e) => e.key === \"Enter\" && send()}\n          placeholder=\"메시지를 입력하세요…\"\n          className=\"flex-1 rounded-xl border px-3 py-2\"\n        />\n        <button\n          onClick={send}\n          className=\"rounded-xl bg-sky-600 hover:bg-sky-700 text-white px-4 py-2\"\n        >\n          전송\n        </button>\n      </footer>\n    </main>\n  );\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}