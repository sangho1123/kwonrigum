{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/sanghojeong/Desktop/Projects/%EA%B6%8C%EB%A6%AC%EA%B8%88%EC%A4%91%EA%B0%9C%EC%95%B1/shop-transfer-1.0/lib/db.ts"],"sourcesContent":["// lib/db.ts\nimport { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as unknown as { prisma?: PrismaClient };\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"error\", \"warn\"] : [\"error\"],\n  });\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\n"],"names":[],"mappings":"AAAA,YAAY;;;;;AACZ;;AAEA,MAAM,kBAAkB;AAEjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;AAC7E;AAEF,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 72, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/sanghojeong/Desktop/Projects/%EA%B6%8C%EB%A6%AC%EA%B8%88%EC%A4%91%EA%B0%9C%EC%95%B1/shop-transfer-1.0/app/api/chat/unread/route.ts"],"sourcesContent":["// app/api/chat/unread/route.ts\nimport { prisma } from \"@/lib/db\";\nimport { NextResponse } from \"next/server\";\n\n/**\n * GET /api/chat/unread?role=admin|user\n * - 각 쓰레드의 \"가장 최근 메시지 시각\"이\n *   lastAdminReadAt / lastUserReadAt 보다 최신이면 => 미읽음으로 카운트\n */\nexport async function GET(req: Request) {\n  try {\n    const { searchParams } = new URL(req.url);\n    const role = (searchParams.get(\"role\") === \"user\" ? \"user\" : \"admin\") as\n      | \"admin\"\n      | \"user\";\n\n    // 모든 쓰레드의 최근 메시지 시각만 가져와 가볍게 계산\n    const threads = await prisma.thread.findMany({\n      select: {\n        id: true,\n        lastAdminReadAt: true,\n        lastUserReadAt: true,\n        messages: {\n          select: { at: true },\n          orderBy: { at: \"desc\" },\n          take: 1, // 최신 메시지 1개만\n        },\n      },\n    });\n\n    const count = threads.reduce((acc, t) => {\n      const lastMsgAt = t.messages[0]?.at ?? null;\n      if (!lastMsgAt) return acc; // 메시지 자체가 없으면 미읽음 아님\n\n      if (role === \"admin\") {\n        return !t.lastAdminReadAt || lastMsgAt > t.lastAdminReadAt ? acc + 1 : acc;\n      } else {\n        return !t.lastUserReadAt || lastMsgAt > t.lastUserReadAt ? acc + 1 : acc;\n      }\n    }, 0);\n\n    return NextResponse.json({ ok: true, count });\n  } catch (e: any) {\n    return NextResponse.json(\n      { ok: false, error: e?.message ?? \"server error\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"AAAA,+BAA+B;;;;;AAC/B;AACA;;;AAOO,eAAe,IAAI,GAAY;IACpC,IAAI;QACF,MAAM,EAAE,YAAY,EAAE,GAAG,IAAI,IAAI,IAAI,GAAG;QACxC,MAAM,OAAQ,aAAa,GAAG,CAAC,YAAY,SAAS,SAAS;QAI7D,gCAAgC;QAChC,MAAM,UAAU,MAAM,qHAAM,CAAC,MAAM,CAAC,QAAQ,CAAC;YAC3C,QAAQ;gBACN,IAAI;gBACJ,iBAAiB;gBACjB,gBAAgB;gBAChB,UAAU;oBACR,QAAQ;wBAAE,IAAI;oBAAK;oBACnB,SAAS;wBAAE,IAAI;oBAAO;oBACtB,MAAM;gBACR;YACF;QACF;QAEA,MAAM,QAAQ,QAAQ,MAAM,CAAC,CAAC,KAAK;YACjC,MAAM,YAAY,EAAE,QAAQ,CAAC,EAAE,EAAE,MAAM;YACvC,IAAI,CAAC,WAAW,OAAO,KAAK,qBAAqB;YAEjD,IAAI,SAAS,SAAS;gBACpB,OAAO,CAAC,EAAE,eAAe,IAAI,YAAY,EAAE,eAAe,GAAG,MAAM,IAAI;YACzE,OAAO;gBACL,OAAO,CAAC,EAAE,cAAc,IAAI,YAAY,EAAE,cAAc,GAAG,MAAM,IAAI;YACvE;QACF,GAAG;QAEH,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAM;QAAM;IAC7C,EAAE,OAAO,GAAQ;QACf,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,IAAI;YAAO,OAAO,GAAG,WAAW;QAAe,GACjD;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}