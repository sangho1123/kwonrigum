{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/sanghojeong/Desktop/Projects/%EA%B6%8C%EB%A6%AC%EA%B8%88%EC%A4%91%EA%B0%9C%EC%95%B1/my-shop-transfer-app-1.3/lib/db.ts"],"sourcesContent":["// lib/db.ts\nimport { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as unknown as { prisma?: PrismaClient };\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"error\", \"warn\"] : [\"error\"],\n  });\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\n"],"names":[],"mappings":"AAAA,YAAY;;;;;AACZ;;AAEA,MAAM,kBAAkB;AAEjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;AAC7E;AAEF,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 66, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/sanghojeong/Desktop/Projects/%EA%B6%8C%EB%A6%AC%EA%B8%88%EC%A4%91%EA%B0%9C%EC%95%B1/my-shop-transfer-app-1.3/lib/partners.ts"],"sourcesContent":["// lib/partners.ts\n\nexport type PartnerType = \"broker\" | \"lender\" | \"fitout\" | \"closure\";\n\nexport type Partner = {\n  id: string;\n  name: string;\n  type: PartnerType;\n  areas?: string[];       // [\"강남구\", \"관악구\"] 등\n  categories?: string[];  // [\"카페/디저트\", \"치킨\"] 등\n  webhookUrl: string;     // 우리 서버의 수신 데모 엔드포인트로 연결\n};\n\n// 데모 파트너 레지스트리\nexport const partners: Partner[] = [\n  {\n    id: \"lend-001\",\n    name: \"샘플 대출 제휴사\",\n    type: \"lender\",\n    areas: [\"강남구\", \"관악구\"],\n    webhookUrl: \"/api/partners/webhook\",\n  },\n  {\n    id: \"fit-001\",\n    name: \"샘플 인테리어 제휴사\",\n    type: \"fitout\",\n    areas: [\"강남구\", \"관악구\"],\n    webhookUrl: \"/api/partners/webhook\",\n  },\n  {\n    id: \"close-001\",\n    name: \"샘플 폐업정리 제휴사\",\n    type: \"closure\",\n    webhookUrl: \"/api/partners/webhook\",\n  },\n];\n"],"names":[],"mappings":"AAAA,kBAAkB;;;;;AAcX,MAAM,WAAsB;IACjC;QACE,IAAI;QACJ,MAAM;QACN,MAAM;QACN,OAAO;YAAC;YAAO;SAAM;QACrB,YAAY;IACd;IACA;QACE,IAAI;QACJ,MAAM;QACN,MAAM;QACN,OAAO;YAAC;YAAO;SAAM;QACrB,YAAY;IACd;IACA;QACE,IAAI;QACJ,MAAM;QACN,MAAM;QACN,YAAY;IACd;CACD","debugId":null}},
    {"offset": {"line": 109, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/sanghojeong/Desktop/Projects/%EA%B6%8C%EB%A6%AC%EA%B8%88%EC%A4%91%EA%B0%9C%EC%95%B1/my-shop-transfer-app-1.3/app/api/leads/route.ts"],"sourcesContent":["// app/api/leads/route.ts\nimport { prisma } from \"@/lib/db\";\nimport { partners } from \"@/lib/partners\";\nimport { NextResponse } from \"next/server\";\n\n// GET: 최근 리드 목록 가져오기 (Admin 페이지용)\nexport async function GET() {\n  try {\n    const rows = await prisma.lead.findMany({\n      orderBy: { createdAt: \"desc\" },\n      take: 200, // 필요하면 숫자 조절\n    });\n\n    const items = rows.map((r) => ({\n      id: r.id,\n      type: r.type as \"listing\" | \"loan\" | \"fitout\" | \"closure\",\n      listingId: r.listingId ?? undefined,\n      name: r.name,\n      phone: r.phone,\n      message: r.message ?? undefined,\n      payload: r.payload ?? undefined,\n      partnerId: r.partnerId ?? null,\n      // AdminLeadsPage에서 number로 쓰고 있으니 timestamp로 변환\n      createdAt: r.createdAt.getTime(),\n    }));\n\n    return NextResponse.json({ ok: true, items });\n  } catch (e: any) {\n    return NextResponse.json(\n      { ok: false, error: e?.message || \"서버 오류\" },\n      { status: 500 }\n    );\n  }\n}\n\n// POST: 리드 생성 + 파트너 웹훅 전송\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json();\n    const {\n      type = \"listing\",\n      listingId,\n      name,\n      phone,\n      message,\n      payload,\n    } = body;\n\n    if (!name || !phone) {\n      return NextResponse.json(\n        { ok: false, error: \"필수 값 누락(name, phone)\" },\n        { status: 400 }\n      );\n    }\n\n    // listingId 숫자 변환 (문자로 들어와도 처리)\n    let listingIdNum: number | null = null;\n    if (typeof listingId === \"number\") {\n      listingIdNum = listingId;\n    } else if (typeof listingId === \"string\" && listingId.trim() !== \"\") {\n      const n = Number(listingId);\n      if (Number.isFinite(n)) listingIdNum = n;\n    }\n\n    // 1) DB에 리드 생성 (처음에는 partnerId 없이)\n    const created = await prisma.lead.create({\n      data: {\n        type: String(type),\n        listingId: listingIdNum,\n        name: String(name),\n        phone: String(phone),\n        message: message ? String(message) : null,\n        payload: payload ?? null,\n        partnerId: null,\n      },\n    });\n\n    let partnerId: string | null = null;\n\n    // 2) 간단한 라우팅: 타입별 첫 파트너\n    const partner =\n      (type === \"loan\" && partners.find((p) => p.type === \"lender\")) ||\n      (type === \"fitout\" && partners.find((p) => p.type === \"fitout\")) ||\n      (type === \"closure\" && partners.find((p) => p.type === \"closure\")) ||\n      null;\n\n    if (partner) {\n      try {\n        await fetch(partner.webhookUrl, {\n          method: \"POST\",\n          headers: { \"Content-Type\": \"application/json\" },\n          body: JSON.stringify({\n            partnerId: partner.id,\n            lead: {\n              id: created.id,\n              type,\n              listingId: listingIdNum,\n              name,\n              phone,\n              message,\n              payload,\n              createdAt: created.createdAt.getTime(),\n            },\n          }),\n        });\n\n        // 웹훅 성공 시 DB에 partnerId 업데이트\n        await prisma.lead.update({\n          where: { id: created.id },\n          data: { partnerId: partner.id },\n        });\n        partnerId = partner.id;\n      } catch {\n        // 파트너 호출 실패해도 리드는 DB에 남아 있게 둠\n      }\n    }\n\n    console.log(\"[LEAD][DB]\", { id: created.id, partnerId });\n\n    return NextResponse.json({\n      ok: true,\n      id: created.id,\n      partnerId,\n    });\n  } catch (e: any) {\n    return NextResponse.json(\n      { ok: false, error: e?.message || \"서버 오류\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}}]
}