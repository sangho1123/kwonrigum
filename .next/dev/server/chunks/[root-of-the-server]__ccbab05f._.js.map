{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/sanghojeong/Desktop/Projects/%EA%B6%8C%EB%A6%AC%EA%B8%88%EC%A4%91%EA%B0%9C%EC%95%B1/shop-transfer-1.0/lib/db.ts"],"sourcesContent":["// lib/db.ts\nimport { PrismaClient } from \"@prisma/client\";\n\nconst globalForPrisma = globalThis as unknown as { prisma?: PrismaClient };\n\nexport const prisma =\n  globalForPrisma.prisma ??\n  new PrismaClient({\n    log: process.env.NODE_ENV === \"development\" ? [\"query\", \"error\", \"warn\"] : [\"error\"],\n  });\n\nif (process.env.NODE_ENV !== \"production\") globalForPrisma.prisma = prisma;\n"],"names":[],"mappings":"AAAA,YAAY;;;;;AACZ;;AAEA,MAAM,kBAAkB;AAEjB,MAAM,SACX,gBAAgB,MAAM,IACtB,IAAI,6IAAY,CAAC;IACf,KAAK,uCAAyC;QAAC;QAAS;QAAS;KAAO,GAAG;AAC7E;AAEF,wCAA2C,gBAAgB,MAAM,GAAG","debugId":null}},
    {"offset": {"line": 72, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/sanghojeong/Desktop/Projects/%EA%B6%8C%EB%A6%AC%EA%B8%88%EC%A4%91%EA%B0%9C%EC%95%B1/shop-transfer-1.0/app/api/chat/threads/route.ts"],"sourcesContent":["// app/api/chat/threads/route.ts\nimport { prisma } from \"@/lib/db\";\nimport { NextResponse } from \"next/server\";\n\nexport const dynamic = \"force-dynamic\"; // (선택) 캐시 방지\n\n// 목록 조회\nexport async function GET(_req: Request) {\n  try {\n    const threads = await prisma.thread.findMany({\n      orderBy: { createdAt: \"desc\" },\n      // include와 select를 섞지 않고 select만 사용\n      select: {\n        id: true,\n        type: true,\n        listingId: true,\n        createdAt: true,\n        lastAdminReadAt: true,\n        lastUserReadAt: true,\n        // ─ listing 제목\n        listing: { select: { title: true } },\n        // ─ 마지막 메시지 1건\n        messages: {\n          select: { text: true, at: true, from: true },\n          orderBy: { at: \"desc\" },\n          take: 1,\n        },\n        // ─ 갯수\n        _count: { select: { messages: true } },\n      },\n    });\n\n    const items = threads.map((t) => {\n      const last = t.messages[0] ?? null;\n      const lastAt = last?.at ?? null;\n\n      return {\n        id: t.id,\n        type: t.type,\n        listingId: t.listingId ?? null,\n        title: t.listing?.title ?? null,\n        createdAt: t.createdAt,\n        lastAt,\n        lastText: last?.text ?? \"-\",\n        messageCount: t._count.messages,\n        unreadForAdmin:\n          !!(lastAt && (!t.lastAdminReadAt || t.lastAdminReadAt < lastAt)),\n        unreadForUser:\n          !!(lastAt && (!t.lastUserReadAt || t.lastUserReadAt < lastAt)),\n      };\n    });\n\n    return NextResponse.json({ ok: true, items });\n  } catch (e: any) {\n    return NextResponse.json(\n      { ok: false, error: e?.message ?? \"server error\" },\n      { status: 500 },\n    );\n  }\n}\n\n// 생성(또는 재사용)\nexport async function POST(req: Request) {\n  try {\n    const body = await req.json().catch(() => ({}));\n    const type = String(body?.type ?? \"\");\n    const listingId =\n      body?.listingId === undefined || body?.listingId === null\n        ? null\n        : Number(body.listingId);\n    const title =\n      body?.title === undefined || body?.title === null\n        ? null\n        : String(body.title);\n\n    if (!type || listingId === null || Number.isNaN(listingId)) {\n      return NextResponse.json(\n        { ok: false, error: \"type, listingId required\" },\n        { status: 400 },\n      );\n    }\n\n    // 이미 존재하면 재사용\n    let thread = await prisma.thread.findFirst({\n      where: { type, listingId },\n      select: { id: true, type: true, listingId: true, title: true },\n    });\n\n    // 없으면 생성\n    if (!thread) {\n      thread = await prisma.thread.create({\n        data: { type, listingId, title },\n        select: { id: true, type: true, listingId: true, title: true },\n      });\n    }\n\n    return NextResponse.json({ ok: true, thread });\n  } catch (e: any) {\n    return NextResponse.json(\n      { ok: false, error: e?.message ?? \"server error\" },\n      { status: 500 },\n    );\n  }\n}\n"],"names":[],"mappings":"AAAA,gCAAgC;;;;;;;;;AAChC;AACA;;;AAEO,MAAM,UAAU,iBAAiB,aAAa;AAG9C,eAAe,IAAI,IAAa;IACrC,IAAI;QACF,MAAM,UAAU,MAAM,qHAAM,CAAC,MAAM,CAAC,QAAQ,CAAC;YAC3C,SAAS;gBAAE,WAAW;YAAO;YAC7B,oCAAoC;YACpC,QAAQ;gBACN,IAAI;gBACJ,MAAM;gBACN,WAAW;gBACX,WAAW;gBACX,iBAAiB;gBACjB,gBAAgB;gBAChB,eAAe;gBACf,SAAS;oBAAE,QAAQ;wBAAE,OAAO;oBAAK;gBAAE;gBACnC,eAAe;gBACf,UAAU;oBACR,QAAQ;wBAAE,MAAM;wBAAM,IAAI;wBAAM,MAAM;oBAAK;oBAC3C,SAAS;wBAAE,IAAI;oBAAO;oBACtB,MAAM;gBACR;gBACA,OAAO;gBACP,QAAQ;oBAAE,QAAQ;wBAAE,UAAU;oBAAK;gBAAE;YACvC;QACF;QAEA,MAAM,QAAQ,QAAQ,GAAG,CAAC,CAAC;YACzB,MAAM,OAAO,EAAE,QAAQ,CAAC,EAAE,IAAI;YAC9B,MAAM,SAAS,MAAM,MAAM;YAE3B,OAAO;gBACL,IAAI,EAAE,EAAE;gBACR,MAAM,EAAE,IAAI;gBACZ,WAAW,EAAE,SAAS,IAAI;gBAC1B,OAAO,EAAE,OAAO,EAAE,SAAS;gBAC3B,WAAW,EAAE,SAAS;gBACtB;gBACA,UAAU,MAAM,QAAQ;gBACxB,cAAc,EAAE,MAAM,CAAC,QAAQ;gBAC/B,gBACE,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC,EAAE,eAAe,IAAI,EAAE,eAAe,GAAG,MAAM,CAAC;gBACjE,eACE,CAAC,CAAC,CAAC,UAAU,CAAC,CAAC,EAAE,cAAc,IAAI,EAAE,cAAc,GAAG,MAAM,CAAC;YACjE;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAM;QAAM;IAC7C,EAAE,OAAO,GAAQ;QACf,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,IAAI;YAAO,OAAO,GAAG,WAAW;QAAe,GACjD;YAAE,QAAQ;QAAI;IAElB;AACF;AAGO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,OAAO,MAAM,IAAI,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QAC7C,MAAM,OAAO,OAAO,MAAM,QAAQ;QAClC,MAAM,YACJ,MAAM,cAAc,aAAa,MAAM,cAAc,OACjD,OACA,OAAO,KAAK,SAAS;QAC3B,MAAM,QACJ,MAAM,UAAU,aAAa,MAAM,UAAU,OACzC,OACA,OAAO,KAAK,KAAK;QAEvB,IAAI,CAAC,QAAQ,cAAc,QAAQ,OAAO,KAAK,CAAC,YAAY;YAC1D,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,IAAI;gBAAO,OAAO;YAA2B,GAC/C;gBAAE,QAAQ;YAAI;QAElB;QAEA,cAAc;QACd,IAAI,SAAS,MAAM,qHAAM,CAAC,MAAM,CAAC,SAAS,CAAC;YACzC,OAAO;gBAAE;gBAAM;YAAU;YACzB,QAAQ;gBAAE,IAAI;gBAAM,MAAM;gBAAM,WAAW;gBAAM,OAAO;YAAK;QAC/D;QAEA,SAAS;QACT,IAAI,CAAC,QAAQ;YACX,SAAS,MAAM,qHAAM,CAAC,MAAM,CAAC,MAAM,CAAC;gBAClC,MAAM;oBAAE;oBAAM;oBAAW;gBAAM;gBAC/B,QAAQ;oBAAE,IAAI;oBAAM,MAAM;oBAAM,WAAW;oBAAM,OAAO;gBAAK;YAC/D;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,IAAI;YAAM;QAAO;IAC9C,EAAE,OAAO,GAAQ;QACf,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,IAAI;YAAO,OAAO,GAAG,WAAW;QAAe,GACjD;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}